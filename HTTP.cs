// Decompiled with JetBrains decompiler
// Type: HTTP
// Assembly: SQLi Dumper, Version=8.5.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FFDD07D3-5737-4188-BACA-DE2D004C7CCF
// Assembly location: C:\Users\cole\Desktop\SQLi Dumper v8.5 [VeryClean]\SQLi v.8.5 VeryClean by Stephanny.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using System;
using System.IO;
using System.Net;
using System.Runtime.CompilerServices;
using System.Text;
using System.Web;

public class HTTP : IDisposable
{
  internal HttpRequest WebRequest;
  internal HttpResponse WebResponse;
  private int __TimeOut;
  private bool __DesableProxy;
  private const string HTTP_DEFAUFT_ACCEPT = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";
  private const string HTTP_DEFAUFT_GET_CONTENT_TYPE = "text/html; charset=utf-8";
  private const string HTTP_DEFAUFT_POST_CONTENT_TYPE = "application/x-www-form-urlencoded";
  private bool __Disposed;

  public HTTP(int iTimeOut, bool bDesableProxy = false)
  {
    this.__TimeOut = iTimeOut;
    this.__DesableProxy = bDesableProxy;
  }

  public string GetHTML(
    string sUrl,
    enHTTPMethod oMethod = enHTTPMethod.GET,
    ref string sPostData = "",
    object oCokies = null,
    NetworkCredential oCredentials = null,
    bool bIsDebugable = true,
    ref string sErrDesc = "")
  {
    string s = "";
    string sProxy = "N/A";
    bool flag = Globals.G_LOG.EnableLog & (Globals.G_LOG.ShowAllLog | bIsDebugable);
    string sID = "";
    TimeSpan ts;
    string sStatus;
    long num1;
    try
    {
      if (flag)
        ts = new TimeSpan(DateAndTime.Now.Ticks);
      Uri requestUri = new Uri(sUrl);
      string str1 = "";
      HttpWebRequest httpWebRequest = (HttpWebRequest) System.Net.WebRequest.Create(requestUri);
      httpWebRequest.AllowAutoRedirect = Globals.HTTP_ALLOW_AUTO_REDIRECT;
      httpWebRequest.Credentials = (ICredentials) oCredentials;
      lock (Globals.G_Proxy)
      {
        if (Globals.G_Proxy.Enable & !this.__DesableProxy)
        {
          httpWebRequest.Proxy = (IWebProxy) Globals.G_Proxy.Proxy;
          sProxy = Globals.G_Proxy.Proxy.Address.Host + ":" + Conversions.ToString(Globals.G_Proxy.Proxy.Address.Port);
        }
      }
      httpWebRequest.Timeout = this.__TimeOut;
      httpWebRequest.ReadWriteTimeout = this.__TimeOut;
      httpWebRequest.Accept = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";
      httpWebRequest.UserAgent = Globals.USER_AGENT;
      httpWebRequest.AutomaticDecompression = ~DecompressionMethods.None;
      httpWebRequest.KeepAlive = true;
      httpWebRequest.Referer = sUrl;
      httpWebRequest.CookieContainer = new CookieContainer();
      if (oCokies is string)
        str1 = Conversions.ToString(oCokies);
      else if (oCokies is CookieCollection && oCokies != null)
      {
        CookieContainer cookieContainer = httpWebRequest.CookieContainer;
        object[] objArray = new object[1]
        {
          RuntimeHelpers.GetObjectValue(oCokies)
        };
        object[] Arguments = objArray;
        bool[] flagArray = new bool[1]{ true };
        bool[] CopyBack = flagArray;
        NewLateBinding.LateCall((object) cookieContainer, (Type) null, "Add", Arguments, (string[]) null, (Type[]) null, CopyBack, true);
        if (flagArray[0])
          oCokies = RuntimeHelpers.GetObjectValue(objArray[0]);
      }
      if (!string.IsNullOrEmpty(str1))
      {
        string[] strArray1 = str1.Split(';');
        int index1 = 0;
        while (index1 < strArray1.Length)
        {
          string str2 = strArray1[index1];
          try
          {
            string[] strArray2 = str2.Split('=');
            strArray2[0] = strArray2[0].Trim();
            strArray2[1] = strArray2[1].Trim();
            if (strArray2.Length > 2)
            {
              int num2 = checked (strArray2.Length - 1);
              int index2 = 2;
              while (index2 <= num2)
              {
                string[] strArray3 = strArray2;
                strArray3[1] = strArray3[1] + "=" + strArray2[index2];
                checked { ++index2; }
              }
            }
            if (strArray2.Length >= 2)
            {
              if (strArray2[0].Trim().Length > 0 & strArray2[1].Trim().Length > 0)
                httpWebRequest.CookieContainer.Add(new Uri(sUrl), new Cookie(strArray2[0], strArray2[1]));
            }
          }
          catch (Exception ex)
          {
            ProjectData.SetProjectError(ex);
            ProjectData.ClearProjectError();
          }
          checked { ++index1; }
        }
      }
      if (oMethod == enHTTPMethod.GET)
      {
        httpWebRequest.ContentType = "text/html; charset=utf-8";
        httpWebRequest.Method = HttpRequest.HttpMethod.Get.ToString();
      }
      else
      {
        if (Globals.HTTP_ENCONDING_HEADERS)
          sPostData = Globals.G_Utilities.EncodeURL(sPostData);
        httpWebRequest.ContentType = "application/x-www-form-urlencoded";
        httpWebRequest.Method = HttpRequest.HttpMethod.Post.ToString();
        httpWebRequest.ContentLength = (long) sPostData.Length;
        httpWebRequest.KeepAlive = false;
        using (Stream requestStream = httpWebRequest.GetRequestStream())
        {
          byte[] bytes = Encoding.ASCII.GetBytes(sPostData);
          requestStream.Write(bytes, 0, bytes.Length);
          requestStream.Close();
        }
      }
      if (flag)
      {
        lock (Globals.G_LOG)
          sID = Globals.G_LOG.AddLog(sUrl, sProxy);
      }
      this.WebRequest = new HttpRequest((System.Net.WebRequest) httpWebRequest);
      this.WebResponse = this.WebRequest.GetRequest();
      if (this.WebResponse != null)
      {
        s = this.WebResponse.SourceCode;
        sStatus = Conversions.ToString((int) this.WebResponse.HTTPResponse.StatusCode) + " - " + this.WebResponse.HTTPResponse.StatusDescription;
      }
      else
      {
        s = "";
        sStatus = "Not Found";
      }
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      Exception exception = ex;
      sErrDesc = exception.Message;
      sStatus = sErrDesc;
      ProjectData.ClearProjectError();
    }
    finally
    {
      if (flag)
        num1 = checked ((long) Math.Round(new TimeSpan(DateAndTime.Now.Ticks).Subtract(ts).TotalMilliseconds));
    }
    try
    {
      if (flag)
      {
        lock (Globals.G_LOG)
          Globals.G_LOG.UpdateLog(sID, sUrl, Globals.G_Utilities.FormatBytes((double) s.Length), Conversions.ToString(num1) + "ms", sStatus);
      }
      checked { Globals.TRAFFIC_RECEIVED += (long) s.Length; }
      Globals.G_Main.UpDateTrafic();
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      ProjectData.ClearProjectError();
    }
    return HttpUtility.HtmlDecode(s);
  }

  protected virtual void Dispose(bool b)
  {
    if (!this.__Disposed)
    {
      this.WebRequest = (HttpRequest) null;
      this.WebResponse = (HttpResponse) null;
    }
    this.__Disposed = true;
  }

  public void Dispose()
  {
    this.Dispose(true);
    GC.SuppressFinalize((object) this);
  }
}
