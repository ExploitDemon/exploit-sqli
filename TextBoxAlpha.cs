// Decompiled with JetBrains decompiler
// Type: TextBoxAlpha
// Assembly: SQLi Dumper, Version=8.5.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FFDD07D3-5737-4188-BACA-DE2D004C7CCF
// Assembly location: C:\Users\cole\Desktop\SQLi Dumper v8.5 [VeryClean]\SQLi v.8.5 VeryClean by Stephanny.exe

using Microsoft.VisualBasic.CompilerServices;
using System;
using System.ComponentModel;
using System.Drawing;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;
using System.Windows.Forms;

public class TextBoxAlpha : TextBox
{
  private TextBoxAlpha.uPictureBox myPictureBox;
  private bool myUpToDate;
  private bool myCaretUpToDate;
  private Bitmap myBitmap;
  private Bitmap myAlphaBitmap;
  private int myFontHeight;
  private Timer myTimer1;
  private bool myCaretState;
  private bool myPaintedFirstTime;
  private Color myBackColor;
  private int myBackAlpha;
  private System.ComponentModel.Container components;

  public TextBoxAlpha()
  {
    this.myUpToDate = false;
    this.myCaretUpToDate = false;
    this.myFontHeight = 10;
    this.myCaretState = true;
    this.myPaintedFirstTime = false;
    this.myBackColor = Color.White;
    this.myBackAlpha = 10;
    this.components = (System.ComponentModel.Container) null;
    this.InitializeComponent();
    this.BackColor = this.myBackColor;
    this.SetStyle(ControlStyles.UserPaint, false);
    this.SetStyle(ControlStyles.AllPaintingInWmPaint, true);
    this.SetStyle(ControlStyles.DoubleBuffer, true);
    this.myPictureBox = new TextBoxAlpha.uPictureBox();
    this.Controls.Add((Control) this.myPictureBox);
    this.myPictureBox.Dock = DockStyle.Fill;
  }

  protected override void OnResize(EventArgs e)
  {
    base.OnResize(e);
    this.myBitmap = new Bitmap(this.ClientRectangle.Width, this.ClientRectangle.Height);
    this.myAlphaBitmap = new Bitmap(this.ClientRectangle.Width, this.ClientRectangle.Height);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnKeyDown(KeyEventArgs e)
  {
    base.OnKeyDown(e);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnKeyUp(KeyEventArgs e)
  {
    base.OnKeyUp(e);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnKeyPress(KeyPressEventArgs e)
  {
    base.OnKeyPress(e);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnMouseUp(MouseEventArgs e)
  {
    base.OnMouseUp(e);
    this.Invalidate();
  }

  protected override void OnGiveFeedback(GiveFeedbackEventArgs gfbevent)
  {
    base.OnGiveFeedback(gfbevent);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnMouseLeave(EventArgs e)
  {
    Point position = Cursor.Position;
    if (this.Bounds.Contains(this.FindForm().PointToClient(position)))
      return;
    base.OnMouseLeave(e);
  }

  protected override void OnChangeUICues(UICuesEventArgs e)
  {
    base.OnChangeUICues(e);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnGotFocus(EventArgs e)
  {
    base.OnGotFocus(e);
    this.myCaretUpToDate = false;
    this.myUpToDate = false;
    this.Invalidate();
    this.myTimer1 = new Timer((IContainer) this.components);
    this.myTimer1.Interval = checked ((int) TextBoxAlpha.win32.GetCaretBlinkTime());
    this.myTimer1.Tick += new EventHandler(this.myTimer1_Tick);
    this.myTimer1.Enabled = true;
  }

  protected override void OnLostFocus(EventArgs e)
  {
    base.OnLostFocus(e);
    this.myCaretUpToDate = false;
    this.myUpToDate = false;
    this.Invalidate();
    this.myTimer1.Dispose();
  }

  protected override void OnFontChanged(EventArgs e)
  {
    if (this.myPaintedFirstTime)
      this.SetStyle(ControlStyles.UserPaint, false);
    base.OnFontChanged(e);
    if (this.myPaintedFirstTime)
      this.SetStyle(ControlStyles.UserPaint, true);
    this.myFontHeight = this.GetFontHeight();
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void OnTextChanged(EventArgs e)
  {
    base.OnTextChanged(e);
    this.myUpToDate = false;
    this.Invalidate();
  }

  protected override void WndProc(ref Message m)
  {
    base.WndProc(ref m);
    if (m.Msg == 15)
    {
      this.myPaintedFirstTime = true;
      if (!this.myUpToDate || !this.myCaretUpToDate)
        this.GetBitmaps();
      this.myUpToDate = true;
      this.myCaretUpToDate = true;
      if (this.myPictureBox.Image != null)
        this.myPictureBox.Image.Dispose();
      this.myPictureBox.Image = (Image) this.myAlphaBitmap.Clone();
    }
    else if (m.Msg != 276 && m.Msg != 277)
    {
      if (m.Msg != 513 && m.Msg != 516 && m.Msg != 515)
      {
        if (m.Msg != 512 || m.WParam.ToInt32() == 0)
          return;
        this.myUpToDate = false;
        this.Invalidate();
      }
      else
      {
        this.myUpToDate = false;
        this.Invalidate();
      }
    }
    else
    {
      this.myUpToDate = false;
      this.Invalidate();
    }
  }

  protected override void Dispose(bool disposing)
  {
    if (disposing && this.components != null)
      this.components.Dispose();
    base.Dispose(disposing);
  }

  public new BorderStyle BorderStyle
  {
    get => base.BorderStyle;
    set
    {
      if (this.myPaintedFirstTime)
        this.SetStyle(ControlStyles.UserPaint, false);
      base.BorderStyle = value;
      if (this.myPaintedFirstTime)
        this.SetStyle(ControlStyles.UserPaint, true);
      this.myBitmap = (Bitmap) null;
      this.myAlphaBitmap = (Bitmap) null;
      this.myUpToDate = false;
      this.Invalidate();
    }
  }

  public new Color BackColor
  {
    get => Color.FromArgb((int) base.BackColor.R, (int) base.BackColor.G, (int) base.BackColor.B);
    set
    {
      this.myBackColor = value;
      base.BackColor = value;
      this.myUpToDate = false;
    }
  }

  public override bool Multiline
  {
    get => base.Multiline;
    set
    {
      if (this.myPaintedFirstTime)
        this.SetStyle(ControlStyles.UserPaint, false);
      base.Multiline = value;
      if (this.myPaintedFirstTime)
        this.SetStyle(ControlStyles.UserPaint, true);
      this.myBitmap = (Bitmap) null;
      this.myAlphaBitmap = (Bitmap) null;
      this.myUpToDate = false;
      this.Invalidate();
    }
  }

  private int GetFontHeight()
  {
    Graphics graphics = this.CreateGraphics();
    SizeF sizeF = graphics.MeasureString("X", this.Font);
    graphics.Dispose();
    return checked ((int) Math.Round(Math.Truncate((double) sizeF.Height)));
  }

  private void GetBitmaps()
  {
    if (this.myBitmap == null || this.myAlphaBitmap == null || (this.myBitmap.Width != this.Width || this.myBitmap.Height != this.Height) || (this.myAlphaBitmap.Width != this.Width || this.myAlphaBitmap.Height != this.Height))
    {
      this.myBitmap = (Bitmap) null;
      this.myAlphaBitmap = (Bitmap) null;
    }
    if (this.myBitmap == null)
    {
      this.myBitmap = new Bitmap(this.ClientRectangle.Width, this.ClientRectangle.Height);
      this.myUpToDate = false;
    }
    if (!this.myUpToDate)
    {
      this.SetStyle(ControlStyles.UserPaint, false);
      TextBoxAlpha.win32.CaptureWindow((Control) this, ref this.myBitmap);
      this.SetStyle(ControlStyles.UserPaint, true);
      this.SetStyle(ControlStyles.SupportsTransparentBackColor, true);
      this.BackColor = Color.FromArgb(this.myBackAlpha, this.myBackColor);
    }
    Rectangle destRect = new Rectangle(0, 0, this.ClientRectangle.Width, this.ClientRectangle.Height);
    ImageAttributes imageAttr = new ImageAttributes();
    ColorMap[] map = new ColorMap[1]
    {
      new ColorMap()
    };
    map[0].OldColor = Color.FromArgb((int) byte.MaxValue, this.myBackColor);
    map[0].NewColor = Color.FromArgb(this.myBackAlpha, this.myBackColor);
    imageAttr.SetRemapTable(map);
    if (this.myAlphaBitmap != null)
      this.myAlphaBitmap.Dispose();
    this.myAlphaBitmap = new Bitmap(this.ClientRectangle.Width, this.ClientRectangle.Height);
    Graphics graphics1 = Graphics.FromImage((Image) this.myAlphaBitmap);
    graphics1.DrawImage((Image) this.myBitmap, destRect, 0, 0, this.ClientRectangle.Width, this.ClientRectangle.Height, GraphicsUnit.Pixel, imageAttr);
    graphics1.Dispose();
    if (!this.Focused || this.SelectionLength != 0)
      return;
    Graphics graphics2 = Graphics.FromImage((Image) this.myAlphaBitmap);
    if (!this.myCaretState)
      return;
    Point caret = this.findCaret();
    Pen pen = new Pen(this.ForeColor, 3f);
    graphics2.DrawLine(pen, caret.X, checked (caret.Y + 0), caret.X, checked (caret.Y + this.myFontHeight));
    graphics2.Dispose();
  }

  private Point findCaret()
  {
    Point point = new Point(0);
    int selectionStart = this.SelectionStart;
    IntPtr wParam = new IntPtr(selectionStart);
    point = new Point(TextBoxAlpha.win32.SendMessage(this.Handle, 214, wParam, IntPtr.Zero));
    if (selectionStart == 0)
      point = new Point(0);
    else if (selectionStart >= this.Text.Length)
    {
      wParam = new IntPtr(checked (selectionStart - 1));
      point = new Point(TextBoxAlpha.win32.SendMessage(this.Handle, 214, wParam, IntPtr.Zero));
      Graphics graphics = this.CreateGraphics();
      string text = this.Text.Substring(checked (this.Text.Length - 1), 1) + "X";
      SizeF sizeF1 = graphics.MeasureString(text, this.Font);
      SizeF sizeF2 = graphics.MeasureString("X", this.Font);
      graphics.Dispose();
      int num = checked ((int) Math.Round(Math.Truncate(unchecked ((double) sizeF1.Width - (double) sizeF2.Width))));
      checked { point.X += num; }
      if (selectionStart == this.Text.Length && Operators.CompareString(this.Text.Substring(checked (this.Text.Length - 1), 1), "\n", false) == 0)
      {
        point.X = 1;
        checked { point.Y += this.myFontHeight; }
      }
    }
    return point;
  }

  private void myTimer1_Tick(object sender, EventArgs e)
  {
    this.myCaretState = !this.myCaretState;
    this.myCaretUpToDate = false;
    this.Invalidate();
  }

  private void InitializeComponent() => this.components = new System.ComponentModel.Container();

  [Description("The alpha value used to blend the control's background. Valid values are 0 through 255.")]
  [Category("Appearance")]
  [DesignerSerializationVisibility(DesignerSerializationVisibility.Visible)]
  [Browsable(true)]
  public int BackAlpha
  {
    get => this.myBackAlpha;
    set
    {
      int num = value;
      if (num > (int) byte.MaxValue)
        num = (int) byte.MaxValue;
      this.myBackAlpha = num;
      this.myUpToDate = false;
      this.Invalidate();
    }
  }

  private class uPictureBox : PictureBox
  {
    public uPictureBox()
    {
      this.SetStyle(ControlStyles.Selectable, false);
      this.SetStyle(ControlStyles.UserPaint, true);
      this.SetStyle(ControlStyles.AllPaintingInWmPaint, true);
      this.SetStyle(ControlStyles.DoubleBuffer, true);
      this.Cursor = (Cursor) null;
      this.Enabled = true;
      this.SizeMode = PictureBoxSizeMode.Normal;
    }

    protected override void WndProc(ref Message m)
    {
      if (m.Msg != 513 && m.Msg != 516 && (m.Msg != 515 && m.Msg != 675) && m.Msg != 512)
      {
        if (m.Msg == 514)
          this.Parent.Invalidate();
      }
      else
        TextBoxAlpha.win32.PostMessage(this.Parent.Handle, checked ((uint) m.Msg), m.WParam, m.LParam);
      base.WndProc(ref m);
    }
  }

  public class win32
  {
    public const int WM_MOUSEMOVE = 512;
    public const int WM_LBUTTONDOWN = 513;
    public const int WM_LBUTTONUP = 514;
    public const int WM_RBUTTONDOWN = 516;
    public const int WM_LBUTTONDBLCLK = 515;
    public const int WM_MOUSELEAVE = 675;
    public const int WM_PAINT = 15;
    public const int WM_ERASEBKGND = 20;
    public const int WM_PRINT = 791;
    public const int WM_HSCROLL = 276;
    public const int WM_VSCROLL = 277;
    public const int EM_GETSEL = 176;
    public const int EM_LINEINDEX = 187;
    public const int EM_LINEFROMCHAR = 201;
    public const int EM_POSFROMCHAR = 214;
    private const int WM_PRINTCLIENT = 792;
    private const long PRF_CHECKVISIBLE = 1;
    private const long PRF_NONCLIENT = 2;
    private const long PRF_CLIENT = 4;
    private const long PRF_ERASEBKGND = 8;
    private const long PRF_CHILDREN = 16;
    private const long PRF_OWNED = 32;

    [DllImport("USER32.DLL")]
    public static extern bool PostMessage(IntPtr hwnd, uint msg, IntPtr wParam, IntPtr lParam);

    [DllImport("USER32.DLL")]
    public static extern int SendMessage(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam);

    [DllImport("USER32.DLL")]
    public static extern uint GetCaretBlinkTime();

    public static bool CaptureWindow(Control control, ref Bitmap bitmap)
    {
      Graphics graphics = Graphics.FromImage((Image) bitmap);
      IntPtr lParam = new IntPtr(12);
      IntPtr hdc = graphics.GetHdc();
      TextBoxAlpha.win32.SendMessage(control.Handle, 791, hdc, lParam);
      graphics.ReleaseHdc(hdc);
      graphics.Dispose();
      return true;
    }
  }
}
